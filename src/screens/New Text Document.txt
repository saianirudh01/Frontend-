import React, { useEffect, useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  Image,
  TouchableOpacity,
  FlatList,
  TextInput,
  Dimensions,
  ActivityIndicator,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useNavigation } from '@react-navigation/native';
import { getMySubmissions } from '../services/api';

const windowWidth = Dimensions.get('window').width;
const isLargeScreen = windowWidth >= 900;

export default function DashboardScreen() {
  const navigation = useNavigation<any>();
  const [loading, setLoading] = useState(true);
  const [newsList, setNewsList] = useState<any[]>([]);
  const [filteredList, setFilteredList] = useState<any[]>([]);
  const [searchQuery, setSearchQuery] = useState('');

  useEffect(() => {
    fetchNews();
  }, []);

  const fetchNews = async () => {
    try {
      setLoading(true);
      const data = await getMySubmissions();
      setNewsList(data);
      setFilteredList(data);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = (text: string) => {
    setSearchQuery(text);
    const filtered = newsList.filter((item) =>
      item.title?.toLowerCase().includes(text.toLowerCase())
    );
    setFilteredList(filtered);
  };

  const renderStatusIcon = (status: string) => {
    const lower = status?.toLowerCase();
    switch (lower) {
      case 'draft':
        return (
          <View style={[styles.statusBadge, { backgroundColor: '#FFEB3B' }]}>
            <Ionicons name="pencil" size={14} color="#212121" />
          </View>
        );
      case 'submitted':
        return (
          <View style={[styles.statusBadge, { backgroundColor: '#4CAF50' }]}>
            <Ionicons name="checkmark" size={16} color="#fff" />
          </View>
        );
      case 'live':
      case 'approved':
        return (
          <View style={[styles.doubleTickContainer]}>
            <Ionicons
              name="checkmark"
              size={14}
              color="#fff"
              style={{ marginRight: -4 }}
            />
            <Ionicons name="checkmark" size={14} color="#fff" />
          </View>
        );
      default:
        return (
          <View style={[styles.statusBadge, { backgroundColor: '#BDBDBD' }]}>
            <Ionicons name="ellipse-outline" size={12} color="#fff" />
          </View>
        );
    }
  };

  const renderNewsItem = ({ item }: any) => (
    <TouchableOpacity
      style={styles.card}
      onPress={() => navigation.navigate('ViewNews', { item })}
      activeOpacity={0.8}
    >
      <Image
        source={{
          uri:
            item.mediaUrl ||
            'https://via.placeholder.com/80x80.png?text=News',
        }}
        style={styles.thumbnail}
      />

      <View style={styles.cardContent}>
        <Text numberOfLines={2} style={styles.newsTitle}>
          {item.title || 'Untitled News'}
        </Text>
        <Text style={styles.metaText}>
          {item.category || 'General'} • {item.date || 'No date'} •{' '}
          <Text style={styles.statusText}>
            {item.status || 'Unknown'}
          </Text>
        </Text>
      </View>

      {/* --- Status Icon --- */}
      <View style={styles.statusIconContainer}>
        {renderStatusIcon(item.status)}
      </View>
    </TouchableOpacity>
  );

  if (loading) {
    return (
      <View style={styles.loader}>
        <ActivityIndicator size="large" color="#FDD835" />
      </View>
    );
  }

  return (
    <View style={[styles.container, isLargeScreen && styles.webContainer]}>
      {/* --- Header --- */}
      <View style={[styles.header, isLargeScreen && styles.headerWide]}>
        <View style={styles.profileRow}>
          <Image
            source={require('../assets/logo.png')}
            style={styles.logo}
          />
          <View style={{ marginLeft: 10 }}>
            <Text style={styles.userName}>Rohit Venka Kumar</Text>
            <Text style={styles.userLocation}>Hyderabad</Text>
          </View>
        </View>
        <Ionicons name="menu" size={22} color="#fff" />
      </View>

      {/* --- Search Bar --- */}
      <View style={[styles.searchBar, isLargeScreen && styles.searchWide]}>
        <Ionicons
          name="search"
          size={18}
          color="#757575"
          style={{ marginHorizontal: 8 }}
        />
        <TextInput
          placeholder="Search news..."
          placeholderTextColor="#999"
          value={searchQuery}
          onChangeText={handleSearch}
          style={{ flex: 1, color: '#212121' }}
        />
      </View>

      {/* --- Total Uploads --- */}
      <View style={[styles.infoRow, isLargeScreen && styles.infoWide]}>
        <Text style={styles.totalText}>
          Total Uploads: {filteredList.length}
        </Text>
      </View>

      {/* --- News List --- */}
      <FlatList
        data={filteredList}
        renderItem={renderNewsItem}
        keyExtractor={(item) => item._id || item.id || Math.random().toString()}
        contentContainerStyle={[
          styles.listContent,
          isLargeScreen && styles.listWide,
        ]}
        showsVerticalScrollIndicator={false}
      />

      {/* --- Floating Action Button --- */}
      <TouchableOpacity
        style={styles.fab}
        onPress={() => navigation.navigate('CreateNews')}
      >
        <Ionicons name="add" size={30} color="#212121" />
      </TouchableOpacity>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#fff' },
  webContainer: { alignItems: 'center', backgroundColor: '#F3F3F3' },
  loader: { flex: 1, justifyContent: 'center', alignItems: 'center' },

  header: {
    backgroundColor: '#212121',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 14,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderColor: '#333',
  },
  headerWide: {
    width: '92%',
    maxWidth: 900,
    borderRadius: 10,
    marginTop: 16,
  },

  profileRow: { flexDirection: 'row', alignItems: 'center' },
  logo: { width: 48, height: 48, borderRadius: 8 },
  userName: { color: '#fff', fontWeight: '700', fontSize: 15 },
  userLocation: { color: '#FDD835', fontSize: 13 },

  searchBar: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#F8F9FB',
    borderRadius: 10,
    borderWidth: 1,
    borderColor: '#E6E6E6',
    margin: 16,
    height: 44,
  },
  searchWide: { width: '92%', maxWidth: 900 },

  infoRow: { marginHorizontal: 16, marginBottom: 10 },
  infoWide: { width: '92%', maxWidth: 900 },
  totalText: { fontWeight: '600', color: '#212121' },

  listContent: { paddingBottom: 100 },
  listWide: { width: '92%', maxWidth: 900, alignSelf: 'center' },

  card: {
    flexDirection: 'row',
    backgroundColor: '#fff',
    marginHorizontal: 16,
    marginVertical: 6,
    borderRadius: 10,
    padding: 10,
    borderWidth: 1,
    borderColor: '#eee',
    shadowColor: '#000',
    shadowOpacity: 0.08,
    shadowRadius: 6,
    elevation: 2,
  },
  thumbnail: {
    width: 70,
    height: 70,
    borderRadius: 8,
    backgroundColor: '#eee',
    marginRight: 12,
  },
  cardContent: { flex: 1, justifyContent: 'center' },
  newsTitle: { fontWeight: '700', color: '#212121', fontSize: 14 },
  metaText: { color: '#757575', fontSize: 12, marginTop: 2 },
  statusText: { fontWeight: '500', color: '#212121', textTransform: 'capitalize' },

  statusIconContainer: {
    justifyContent: 'center',
    alignItems: 'center',
  },

  statusBadge: {
    width: 22,
    height: 22,
    borderRadius: 6,
    justifyContent: 'center',
    alignItems: 'center',
  },
  doubleTickContainer: {
    flexDirection: 'row',
    backgroundColor: '#8E24AA',
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 6,
    alignItems: 'center',
    justifyContent: 'center',
  },

  fab: {
    position: 'absolute',
    bottom: 20,
    alignSelf: 'center',
    backgroundColor: '#FDD835',
    width: 64,
    height: 64,
    borderRadius: 32,
    justifyContent: 'center',
    alignItems: 'center',
    shadowColor: '#000',
    shadowOpacity: 0.25,
    shadowRadius: 8,
    elevation: 5,
  },
});
